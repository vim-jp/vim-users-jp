---
layout: post
title: "Hack #20: モードラインでファイルごとにオプションを設定する"
date: 2009-06-02
author: thinca
---
<h3>モードラインとは</h3>

<p>
ある特定のファイルに対して、例えばそのファイルではタブ幅を 8 に固定して欲しかったり、右端で折り返して欲しくなかったりすることがあります。こう言った場合ローカルオプションを設定する必要がありますが、一々設定するのは面倒です。そういう時はモードラインが使えます。
モードラインは、ファイル内に特定の書式の文字列を埋め込んでおくことで、そのファイルを開いた際に自動で Vim のオプションを設定する仕組みです。
</p>

<h3>モードラインの書式</h3>

<p>
モードラインの書式は 2 通りあります。ここではこの 2 つを便宜上 &#8220;書式 1&#8243; &#8220;書式 2&#8243; と呼ぶことにします。
</p>

<table>
<tr><th colspan="2">書式 1</th></tr>
<tr><td colspan="2">[text]{white}{vi:|vim:|ex:}[white]{options}</td></tr>
<tr><th colspan="2">書式 2</th></tr>
<tr><td colspan="2">[text]{white}{vi:|vim:|ex:}[white]se[t] {options}:[text]</td></tr>
<tr><td>[text]</td><td>空文字列を含む任意のテキスト。</td></tr>
<tr><td>{white}</td><td>半角スペースもしくはタブ文字。</td></tr>
<tr><td>{vi:|vim:|ex:}</td><td>&#8220;vi:&#8221; &#8220;vim:&#8221; &#8220;ex:&#8221; のうちいずれかの文字列。</td></tr>
<tr><td>[white]</td><td>半角スペースもしくはタブ文字。なくてもよい。</td></tr>
<tr><td>se[t]</td><td>&#8220;set &#8221; &#8220;se &#8221; のうちいずれかの文字列。空白を含むのに注意。</td></tr>
<tr><td>{options}</td><td><code class="vim-script">:set</code> コマンドに渡す引数。書式 1 に限りオプションの区切りにコロン &#8220;:&#8221; も使用できる。</td></tr>
</table>

<dl>
<dt>例:</dt>
<dd><code>-- vim:ts=8:sw=2:sts=2:st:et </code></dd>
<dd><code>/* vim:set ft=c tw=78 fdm=marker: */</code></dd>
</dl>

<p>
{vi:|vim:|ex:} の前にある空白は、誤認識を減らすためにあります。また、例外として行頭にある &#8220;ex:&#8221; は example: の略の可能性があるため無視されます。書式 2 は書式 1 と比べて se[t] と最後のオプションの後のコロンが必要です。オプションの値に &#8220;:&#8221; を入れたい場合は &#8220;\&#8221; でエスケープする必要があります。
</p>

<p>
書式 1 と書式 2 の大きな違いは、末尾に任意の文字列を入れられるかどうかです。モードラインをソースコードに書き込む場合必然的にコメント内に書き込むことになりますが、C 言語のように行コメントがない言語の場合は、末尾に文字の入れられる書式 2 の方が便利です。あとはどちらを使うかは基本的に好みの問題です。
</p>

<h4>適用する Vim のバージョンを限定する</h4>

<p>
普段用いられることはほとんどありませんが、&#8221;vim:&#8221; の文字列内にバージョンを表記することでそのモードラインを使用する Vim のバージョンを限定することができます。以下のように指定します。
</p>

<table>
<tr><td>vim{vers}:</td><td>バージョン {vers} 以降</td></tr>
<tr><td>vim&lt;{vers}:</td><td>バージョン {vers} より前</td></tr>
<tr><td>vim={vers}:</td><td>バージョン {vers}</td></tr>
<tr><td>vim&gt;{vers}:</td><td>バージョン {vers} より後</td></tr>
</table>

<p>
&#8220;vim:&#8221; 以外の &#8220;vi:&#8221; や &#8220;ex:&#8221; ではこの指定はできません。ここで {vers} は Vim のメジャーバージョン番号を 100 倍したものにマイナーバージョン番号を足したものです。例えば、Vim 7.2 の場合は 702 になります。この数値は Vim スクリプトで利用できる組み込み変数 <code class="vim-script">v:version</code> と同じものです。
</p>

<h3>モードラインを書く場所</h3>

<p>
モードラインはファイルの先頭もしくは末尾に記述します。どの範囲に書かれたものが有効かは、後述する <code class="vim-option">'modelines'</code> で設定します。
</p>

<p>
有効な範囲内に書かれたモードラインは全て適用されます。複数のモードラインを書けばその分が上から順に適用されます。ファイルの先頭と末尾の両方に書いても大丈夫です。
</p>

<h3>モードラインのオプション</h3>

<p>
モードラインに関するオプションは以下の 2 つがあります。
</p>

<dl>
<dt><code class="vim-option">'modeline'</code></dt>
<dd>形式: boolean</dd>
<dd>バッファについてローカル</dd>
<dd>
このオプションが on だと、モードラインが認識されます。通常はデフォルトで on ですが、<code class="vim-option">'compatible'</code> が on (Vi 互換モード) の場合の他、Unix 系 OS における root ユーザの場合もデフォルトで off になるので、必要なら vimrc などで有効にしておくと良いでしょう。
</dd>
<dt><code class="vim-option">'modelines'</code></dt>
<dd>形式: number</dd>
<dd>グローバル</dd>
<dd>
モードラインを認識する行数を設定します。ファイルの先頭もしくは末尾からこのオプションで指定した行数だけモードラインを探します。0 を設定すると <code class="vim-option">'modeline'</code> が on でもモードラインはチェックされません。
</dd>
</dl>

<h3>設定されるオプションの扱い</h3>

<p>
モードラインによって設定されたオプションは <code class="vim-script">:setlocal</code> で設定された場合と同じようになります。グローバルオプションを設定することもできますが、モードラインの目的を考えると不適切なのでやめておいた方がいいでしょう。
</p>

<h3>設定できないオプション</h3>

<p>
<code class="vim-option">'makeprg'</code> などの一部のオプションは、セキュリティ上モードラインで設定することはできません。設定できないオプションは help の各オプションの項目でその旨が記載されています。
</p>

<h3>最後に</h3>

<p>
モードラインは便利な機能ですが、Vim を使っている人以外には理解不能な謎の文字列になります。特に共有するファイルで使用する場合には注意してください。
</p>

<address class="hack-author">thinca</address>
