---
layout: post
title: "Hack #26: 複数のバッファを一度に変更する &#8211; キーボードマクロ編"
date: 2009-06-14
author: kana
---
<h3>問題</h3>

<p>日常的に複数のファイルを取り扱っていると、同じ変更を複数のファイルに対して行いたい場合があります。<a href="/vim-users-jp/2009/06/04/Hack-21.html">Hack #21: 複数のバッファを一度に変更する &#8211; :bufdo編</a>では<code class="lang-vim">:bufdo</code>などを用いた方法を紹介しました。<code class="lang-vim">:%s/.../.../g</code>程度の単純なものならHack #21の方法でも十分なのですが、時にはExコマンドで指定するには複雑な処理を行ないたい場合があります。</p>

<h3>解決方法</h3>

<p>複数のファイルを一斉に変更する別の方法としては、キーボードマクロがあります。
				キーボードマクロはユーザーが行なった一連の操作を記録し、
				後で記録した操作を簡単に繰り返すことができる機能です。</p>

<p>具体例を示しましょう。筆者は過去に自作<a href="http://kana.github.com/config/vim/smartword.html">プラグインのドキュメントのヘッダー</a>にライセンスに関する文章を追記する作業を行ないました。仮にこれを手作業で行なうとすると、以下のような手順になります(ここでは予め作業対象のファイルをargument-listに登録していると仮定します。詳細は<a href="/vim-users-jp/2009/05/15/Hack-11.html">Hack #11: argument listを利用して複数のファイルを取り扱う</a>を参照してください。またライセンスに関する文章はレジスターcに保存されているものとします):</p>

<ol>
<li>ヘッダー中の適切な位置に移動し(<kbd>gg/^Copyright&lt;Return&gt;</kbd>)</li>
<li>ライセンスに関する文章を貼り付け(<kbd>"cp</kbd>)</li>
<li>ファイルを保存し(<kbd>:write&lt;Return&gt;</kbd>)</li>
<li>次のファイルを開く(<kbd>:next&lt;Return&gt;</kbd>)</li>
</ol>

<p>キーボードマクロを用いるとこの作業を記録することができます。
				記録を開始するコマンドは<kbd>qm</kbd>です。
				キーボードマクロの記録を終了するには<kbd>q</kbd>をタイプします。
				記録したキーボードマクロを実行するには<kbd>@m</kbd>をタイプします。</p>

<p>つまり、この例の場合は</p>

<ol>
<li>キーボードマクロの記録を開始する(<kbd>qm</kbd>)</li>
<li>ヘッダー中の適切な位置に移動し(<kbd>gg/^Copyright&lt;Return&gt;</kbd>)</li>
<li>ライセンスに関する文章を貼り付け(<kbd>"cp</kbd>)</li>
<li>ファイルを保存し(<kbd>:write&lt;Return&gt;</kbd>)</li>
<li>次のファイルを開く(<kbd>:next&lt;Return&gt;</kbd>)</li>
<li>キーボードマクロの記録を終了する(<kbd>q</kbd>)</li>
<li>任意の回数だけ繰り返す(<kbd>@m@m@m...</kbd>としても良いですし、<kbd>100@m</kbd>と繰り返し回数を指定することもできます)</li>
</ol>

<p>という手順で作業を半自動化することができます。</p>

<h3>解説</h3>

<p>上記の例では説明を簡略化するため</p>

<ul>
<li>記録を開始するコマンドは<kbd>qm</kbd>です。</li>
<li>記録したキーボードマクロを実行するには<kbd>@m</kbd>をタイプします。</li>
</ul>

<p>と説明しましたが、実際にはmに限らずaからzまでの小文字のアルファベットなら何でも構いません。より正確に言えば、キーボードマクロの記録時には入力された操作をどのレジスターに記録するかを指定し、実行時にはどのレジスターの内容を実行するかを指定しています。</p>

<p>レジスターを利用しているということから、以下の応用例が考えられます:</p>

<ul>
<li>バッファ中に操作手順を書き下してそれをyankすることで、実際に操作を行なうことなくキーボードマクロを記録することができます。</li>
<li>キーボードマクロの記録途中で操作を失敗した場合でも、記録内容をバッファに貼り付れば編集することができます。</li>
<li><kbd>qM</kbd>のように大文字のレジスター名を用いれば既存のキーボードマクロに対してさらに操作を追加することができます。</li>
</ul>

<p>キーボードマクロの利点は普段のVimの操作を行なうだけでちょっとした作業の繰り返しを簡単に半自動化できることです。上手く使えば作業の効率を大きく上げることができるでしょう。</p>

<h3>参考資料</h3>

<ul>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/usr_10.html#10.1">:help 10.1 &#8211; Record and playback commands</a> &#8211; キーボードマクロについての解説</li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/repeat.html#complex-repeat">:help complex-repeat</a> &#8211; キーボードマクロ関連のリファレンス</li>
</ul>

<address class="hack-author">kana</address>
