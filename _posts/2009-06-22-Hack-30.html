---
layout: post
title: "Hack #30: 範囲を指定してコマンドを実行する"
date: 2009-06-22
author: thinca
---
<p>
				Vim のコマンドの中には範囲を指定できるものがあります。範囲を指定することで、より細かい指示を Vim に与えることができます。ここでは範囲の指定の仕方について解説します。
</p>

<h3>範囲を与えられるコマンド</h3>

<p>
				まず最初に注意したいのですが、全てのコマンドに対して範囲を指定できるわけではありません。範囲が指定できるものに関しては help 内で <code class="lang-vim">:{range}<var>command</var></code> や <code class="lang-vim">:[range]<var>command</var></code> などと表記されています。また、<code class="lang-vim">:!</code> などのように範囲を指定するかどうかで動作が変わるコマンドも一部あります。
</p>

<p>
				また、範囲ではなくカウントを与えるコマンドもあります。<code class="lang-vim">:tag</code> などがそうです。が、指定方法に大差はありません。扱われ方が違うだけです。
</p>

<p>
				範囲を指定できるコマンドに対して範囲指定を省略した場合、多くのコマンドは現在の 1 行のみを指定したことになります。ただし例外もあります。例えば、<code class="lang-vim">:global</code> や <code class="lang-vim">:sort</code> は範囲指定を省略するとファイル全体を指定したことになります。
</p>

<h3>範囲の指定方法</h3>

<h4>基本</h4>

<p>
				範囲は行単位で指定します。つまり、ある行からある行まで、ということです。最も単純な例を示します。
</p>

<pre class="prettyprint"><code>:10,20<var>command</var>
</code></pre>

<p>
				これは 10 行目から 20 行目の間の範囲に対して <var>command</var> を実行する、という意味です。ここで、10 や 20 の部分を行指定子と呼びます。行指定子には具体的な数字以外にも以下のものが使用できます。
</p>

<table>
<thead><tr><th>行指定子</th><th>説明</th></tr></thead>
<tbody>
<tr><td><var>{number}</var></td><td>絶対的な行番号です。0 から最終行までの範囲である必要があります。0 を指定した場合、多くのコマンドは 1 として解釈しますが、<code class="lang-vim">:read</code> のような一部のコマンドや続けて検索をする行指定子を指定する場合などは「先頭行の前」として解釈します。また、カウントを与えるコマンドの場合はそのまま 0 として使われます。</td></tr>
<tr><td>.</td><td>現在の行です。</td></tr>
<tr><td>$</td><td>最後の行です。</td></tr>
<tr><td>%</td><td>ファイル全体です。1,$ を指定したのと同じになります。</td></tr>
<tr><td>&#8216;<var>m</var></td><td><kbd>'</kbd> で移動できるマークです。大文字のマークの場合同じファイルに対するマークだった場合のみ使用可能です。</td></tr>
<tr><td>/<var>{pattern}</var>[/] ?<var>{pattern}</var>[?]</td><td>次に <var>{pattern}</var> にマッチする行です。/ は下向き、? は上向きになります。最後の /? は、パターンとその後の項目とを区別する場合に必要です。</td></tr>
<tr><td>\/ \?</td><td>現在行から次に直前に使われた検索パターンにマッチする行です。/ は下向き、? は上向きになります。</td></tr>
<tr><td>\&amp;</td><td>現在行から次に直前に使われた置換元パターンにマッチする行です。</td></tr>
</tbody>
</table>

<p>例: 現在行から最終行を html にしてファイルに出力(参考: <a class="hack" href="/vim-users-jp/2009/06/08/Hack-23.html">Hack #23: Vimでハイライト表示させたコードを見た目そのままにHTML出力させる</a>)</p>

<pre class="prettyprint"><code>:.,$TOhtml
</code></pre>

<h4>行指定子を指定する数</h4>

<p>
				行指定子は 1 つだけ指定することも可能で、その場合指定した 1 行のみが範囲になります。
</p>

<p>
				また、3 つ以上指定することも可能です。この場合、最後の 2 つの範囲が指定されたことになります。このようなことが許可されているのは現在行を調整できるようにするためです。
</p>

<h4>行指定子の区切り</h4>

<p>
				行指定子は カンマ(,)かセミコロン(;)で区切ります。
				セミコロンで区切った場合、次の行指定子を解釈する前にカーソルが前の行指定子で指定した行に移動します。
				コマンド実行後にもカーソルの位置は移動したままです。
</p>

<p>例: 次の &#8220;class&#8221; で始まる行から、その行より下にある次の &#8220;end&#8221; で始まる行までを削除</p>

<pre class="prettyprint"><code>:/^class/;/^end/delete
</code></pre>

<p>
				この例をカンマで区切った場合、現在の行から &#8220;class&#8221; より近い位置に &#8220;end&#8221; があった場合、予期しない結果になるでしょう。
				セミコロンで区切ることでまず &#8220;class&#8221; の行に移動し、その後 &#8220;end&#8221; を探します。ただし、結果としてコマンド実行後にカーソルが移動してしまいます。
</p>

<h4>相対行指定</h4>

<p>
				各行指定子の末尾には、+<var>n</var> -<var>n</var> のように相対行を指定することができます。複数回指定することも可能です。<var>n</var> を省略すると 1 を指定したことになります。
</p>

<p>例: 次の &#8220;class&#8221; で始まる行の次の行から、その行より下にある次の &#8220;end&#8221; で始まる行の前の行までを削除</p>

<pre class="prettyprint"><code>:/^class/+1;/^end/-1delete
</code></pre>

<h4>検索系の行指定子の指定</h4>

<p>
				検索を行なう行指定子 &#8220;/&#8221; と &#8220;?&#8221; は、行指定子の更に後に指定することができます。これを利用すると検索の開始位置を調整できます。セミコロンで区切った場合と違い、カーソル自体は移動しません。
</p>

<p>例: カーソルを移動せずに、次の &#8220;class&#8221; で始まる行から、その行より下にある次の &#8220;end&#8221; で始まる行までを削除</p>

<pre class="prettyprint"><code>:/^class/,/^class//^end/delete
</code></pre>

<p>
				先ほどのセミコロンで区切った場合と違い、カーソルが移動することはありません。
</p>

<h3>自動で入力される範囲</h3>

<h4>Visual mode</h4>

<p>
				Visual mode から Command-line mode に入ると、プロンプトに以下のような文字列が自動的に挿入されます。
</p>

<pre class="prettyprint"><code>:'&lt;,'&gt;
</code></pre>

<p>
				ここで、&#8217;&lt; は Visual mode 最後に選択した範囲の最初の行、&#8217;&gt; は最後の行を表すマークです。つまり、Visual mode から Command-line mode に入ると自動的に今選択していた範囲を対象にコマンドを実行することができます。
</p>

<h4>count</h4>

<p>
				Normal mode で数字を入力してから Command-line mode に入ると、プロンプトに以下のような文字列が自動的に挿入されます。
</p>

<pre class="prettyprint"><code>:.,.+<var>(count - 1)</var>
</code></pre>

<p>
				例えば、<kbd>5:</kbd> と入力すると <code class="lang-vim">:.,.+4</code> と入力された状態になります。これはつまり、現在の行から 5 行分という意味です。
</p>

<h3>範囲の反転</h3>

<p>
				指定した範囲の開始行が終了行より下だった場合、Vim は開始行と終了行を入れ替えても良いか訊いてきます。許可した場合のみ、コマンドは実行されます。<code class="lang-vim">:silent</code> コマンドを前置してコマンドを実行することで、確認せずに入れ替えて実行させることができます。また、<code class="lang-vim">:global</code> コマンドに対して指定するコマンドでも入れ替えの確認は行われません。
</p>

<p>
				範囲の指定方法について紹介しましたが、多くの機能は普段はあまり使いません。ほとんどの場合 Visual mode との組み合わせで事足りると思います。稀に Vim script を書く際に便利なこともありますが、こんな機能もある、程度の認識で問題ないでしょう。
</p>

<address class="hack-author">thinca</address>
