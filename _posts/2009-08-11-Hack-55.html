---
layout: post
title: "Hack #55: 正規表現のメタ文字の扱いを制御する"
date: 2009-08-11
author: thinca
---
<p>Vim では随所で強力な正規表現を利用することができます。Vim は正規表現のメタ文字に関して少々特殊な機構を持っています。
				本 hack では正規表現で重要なメタ文字の Vim 上での扱いについて見ていきます。</p>

<h2>メタ文字</h2>

<p>正規表現にはメタ文字と言うものがあり、これらの文字は正規表現中で特別な意味を持ちます。
				しかし、メタ文字をリテラルとして使用したい場合いちいちエスケープする必要があり面倒です。
				そのために、Vim の正規表現には magic、very magic と言う概念があります。</p>

<h2>magic と very magic</h2>

<p>Vim の正規表現にはメタ文字の処理に関して 4 つの状態があり、状態によってどの文字がメタ文字であるかが変わります。</p>

<ul>
<li>very magic</li>
<li>magic</li>
<li>nomagic</li>
<li>very nomagic</li>
</ul>

<p>下に行くほど記号はリテラル文字として扱われます。very magic は全ての記号はメタ文字として扱われ、
				very nomagic はバックスラッシュ以外の記号は全てリテラル文字として扱われます。
				magic と nomagic はどの文字がメタ文字として扱われるかはまちまちです。help で確認してください。</p>

<p>リテラル文字として扱われる文字もバックスラッシュを前置することでメタ文字として扱えます。
				例えば . (任意の1字を表すメタ文字) は nomagic の際はリテラル文字ですが、\. とすることでメタ文字として扱えます。</p>

<h2>状態の切り替え</h2>

<p>それぞれの状態は正規表現中に \v \m \M \V を置くことで切り替えます。これは書かれた箇所以降で有効になります。
				つまり、1 つの正規表現中で途中で状態を変更することができます。</p>

<p>これは逆に言うと、複数の任意の正規表現を文字列として結合した場合、以前がどの状態になっているかわからないことを意味します。
				正規表現を結合するような処理を行う場合、各正規表現の先頭で状態を設定しておいた方が良いでしょう。</p>

<h2>magic のデフォルト値</h2>

<p>magic の初期値は <code class="option">'magic'</code> オプションで決まります。boolean 型のオプションで、on だと magic、off だと nomagic になります。
				オプション自体のデフォルト値は on です。</p>

<p>ただし、<code class="vim-script">:syntax</code> に指定するパターンや =~ によるマッチング時など一部の場合は
				ポータビリティを高めるために <code class="option">'magic'</code> は常に on に設定されます。</p>

<p>残念なことに、<code class="option">'verymagic'</code> のようなオプションはありません。普段から使いたい場合は、少々強引ですが以下のような Key mapping を使用する方法があります。</p>

<pre><code class="vim-script">nnoremap / /\v
</code></pre>

<address class="hack-author">thinca</address>
