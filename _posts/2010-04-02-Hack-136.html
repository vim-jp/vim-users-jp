---
layout: post
title: "Hack #136: Pythonインタフェースを使う(2)"
date: 2010-04-02
author: tsukkee
---
<p><a href="/vim-users-jp/2010/03/17/Hack-132.html">前回</a>はPythonインタフェースの基本を紹介しましたが、今回はもう少し突っ込んだ内容について紹介しようかと思います。</p>

<h2>変数のコンテキスト</h2>

<p>VimScriptからPythonを起動するとき、Pythonは呼ばれたVimScriptのコンテキストで実行されます。なので、以下の例のようにしてVimScriptとPython間で変数をやりとりすることができます。</p>

<pre class="prettyprint"><code class="lang-vim">0</code></pre>

<p>注意点としては、前回vim.eval()のところでも述べたようにVimScriptの内容は全て文字列になるので数値で欲しい場合は、Python側で<code>0</code>などとキャストする必要があるところです。他にもPythonにはboolean型がありますがVimScriptにはないなど微妙に落とし穴があるので、Python側のif文などでVimScriptの値を参照する際は気を付ける必要があります。また、:pyfileで読み込んだ外部ファイルの中でもこのコンテキストの扱いは有効です。例えば以下の通りです。</p>

<pre class="prettyprint"><code>0</code></pre>

<pre class="prettyprint"><code>0</code></pre>

<p>また:pythonコマンドで生成したPythonの変数は全てグローバル変数となり、Vimの起動から終了まで全て同じコンテキストとなります。</p>

<pre class="prettyprint"><code>0</code></pre>

<h2>ユニコード文字の扱い</h2>

<p>Pythonはスクリプト自体のエンコードを指定する方法としてマジックコメントを使うことができます。これは、スクリプトファイルの1行目か2行目に、<code>0</code>や<code>0</code>などのように<code>0</code>で表される表現があればエンコードとして認識されるというものです。<a href="http://www.python.org/dev/peps/pep-0263/">PEP 0263</a>には.pyファイルをVimで編集する場合は、Vimのモードラインとしても有効になるように以下のように書く例が掲載されています。</p>

<pre class="prettyprint"><code>0</code></pre>

<p>しかしモードラインで<code>0</code>は指定すべきでないので単に、</p>

<pre class="prettyprint"><code>0</code></pre>

<p>などと書くべきです。VimScript内の:pythonコマンドではヒアドキュメント風の書き方を使った場合にだけこのマジックコメントを使うことができます。また、マジックコメントは各コマンドごとに書く必要があります。</p>

<pre class="prettyprint"><code>0</code></pre>

<p>ということなので、マルチバイト文字をやりとりする必要がある場合は基本的に:pythonコマンドで一行でスクリプトを渡す形式を使うことはできず、ヒアドキュメント風の使い方をすることになります。また、より汎用的にするには以下のように書くと良いでしょう。</p>

<pre class="prettyprint"><code>0</code></pre>

<p>Vimから入力を受け取ってPythonに渡すときも同様にしてdecodeすれば文字化けせずにユニコード文字列を渡すことができます。</p>

<h2>Pythonのimport</h2>

<p>例えば、Pythonインタフェースを作ったプラグインを作っていて、Python部分が長くなるので外部に.pyファイルとして出しておきたい場合を考えます。そんなときは、通常は:pyfileを使えば良いのですが、これはグローバル空間でファイルの中身を実行するので、<code>0</code>したときと同様に外部ファイルの関数や変数を全てグローバル空間に展開してしまいます。これを避けるための方法を考えてみます。</p>

<pre class="prettyprint"><code>0</code></pre>

<pre class="prettyprint"><code>0</code></pre>

<pre class="prettyprint"><code>0</code></pre>

<p>このように、VimScript側でスクリプトの置いてあるディレクトリを取得し、sys.pathにパスを追加しておくことで、所望の.pyファイルをimportすることができます。</p>

<p>今回は以上です。前回と今回で説明した内容を理解すれば、Pythonインタフェースを利用したpluginも自在に書けるようになると思います。</p>

<address class="hack-author">tsukkee</address>
