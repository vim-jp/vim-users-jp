---
layout: post
title: "Hack #182: テキストを折り畳む &#8211; marker 編"
date: 2010-11-12
author: thinca
---
<p>Vim での折り畳み機能の折り畳み方法の 1 つに &#8220;marker&#8221; があります。これはテキスト中にマーカーと呼ばれる文字列を埋め込むことで折り畳みの位置やレベルを指定する折り畳み方法です。<code class="option">'foldmethod'</code> オプションに &#8220;marker&#8221; を指定することで使えます。</p>

<h3 id="section">マーカーの書き方</h3>

<p>折り畳みを開始したい行に \{\{\{ を、終了したい行に \}\}\} を書きます。行のどこかに入っていればいいので、コメントのなかに書くといいでしょう。</p>

<pre class="prettyprint"><code>\{\{\{
// この行と開始/終了行を合わせた 3 行が折り畳まれる
\}\}\}
</code></pre>

<p>入れ子にすることが可能で、深くなるごとに折り畳みレベルが増えます。また、1 行に複数のマーカーを置くとその分だけ折り畳みレベルが深くなります。</p>

<pre class="prettyprint"><code>// レベル 0 (折り畳みなし)
\{\{\{
// レベル 1
\{\{\{ \{\{\{
// レベル 3
\}\}\}
// レベル 2
\}\}\}
// レベル 1
</code></pre>

<p>マーカーの後ろに数字を付けることで、レベルを直接指定できます。この場合、途中のレベルを飛ばして折り畳みレベルを設定したり、同じレベルの折り畳みを連続で置くことができます。また、閉じるための \}\}\} は省略できます。</p>

<pre class="prettyprint"><code>\{\{\{1
// レベル 1
\{\{\{3
// レベル 3
\{\{\{3
// レベル 3 だが、上の折り畳みとは別の折り畳み
\}\}\}1
// レベル 1 を閉じたのでここはレベル 0
</code></pre>

<p>レベル付きのマーカーの利点は、確実にレベルが設定されるので直前の折り畳みを閉じる必要がないため、閉じ忘れの心配がない点です。また、同一レベルを連続させたい場合にも有効です。</p>

<p>逆に欠点は、入れ子を簡単には増やせないことです。外側にもっと大きな折り畳みを作りたい場合、内側の折り畳みレベルを全て修正しなくてはいけません。</p>

<h3 id="zf-zd-などによるマーカーの作成と削除"><kbd>zf</kbd> <kbd>zd</kbd> などによるマーカーの作成と削除</h3>

<p><a href="/vim-users-jp/2010/10/23/Hack-178.html">テキストを折り畳む &#8211; 操作編</a> で紹介した <kbd>zf</kbd> や <kbd>zd</kbd> などの折り畳みを作成/削除をするコマンドを使うと、実際にマーカー文字列が挿入されます。</p>

<p>挿入される際は、開始行/終了行の末尾にマーカー文字列が追加されます。<code class="option">'commentstring'</code> オプションが設定されていれば、これを利用してコメントの中にマーカー文字列が入るように挿入されます。</p>

<p>例えば C のソースを編集中に、</p>

<pre class="prettyprint"><code>int main(int argc, char const* argv[]) {
  return 0;
}
</code></pre>

<p>この関数の中で <kbd>zfa{</kbd> とすると、</p>

<pre class="prettyprint"><code>int main(int argc, char const* argv[]) {/*\{\{\{*/
  return 0;
}/*\}\}\}*/
</code></pre>

<p>このようになります。</p>

<p><kbd>zd</kbd> を使うとこれと逆の操作になります。<code class="option">'commentstring'</code> にパターンが一致する場合はコメント部分も取り除かれるので、この例の場合は完全に元通りになります。</p>

<p>この操作で作成されるマーカーはレベルなしのものです。すでにレベル付きのマーカーがある場合、意図しない結果になる可能性があるので注意してください。</p>

<h3 id="foldmarker-オプション"><code class="option">'foldmarker'</code> オプション</h3>

<p>マーカー文字列は <code class="option">'foldmarker'</code> オプションによって変更できます。開始マーカーと終了マーカーをカンマ区切りで指定します。デフォルトでは &#8220;\{\{\{,\}\}\}&#8221; になっています。</p>

<p>このオプションを変更するときは注意してください。マーカー文字列はファイルに直接書かれるものなので、独自の設定を使うと他の人が折り畳みを行えなくなります。どうしても変更が必要な場合は、<a href="/vim-users-jp/2009/06/02/Hack-20.html">modeline</a> に書いておくと良いでしょう。</p>

<h3 id="section-1">注意</h3>

<p>&#8220;marker&#8221; による折り畳みの指定は、手軽で確実ではありますが、Vim 以外のエディタを使っている人には謎の記号になります。特に共有するファイルで使用する場合には注意してください。</p>

<address class="hack-author">thinca</address>
